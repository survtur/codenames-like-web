<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans+Narrow&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">

    <style>

        @import url('https://fonts.googleapis.com/css2?family=PT+Sans+Narrow&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
        h1, h2, h3 {
            margin-bottom: 1rem;
        }
        #wrapper {
            font-family: Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
        }

        .crown-icon-1555642 {
            background-image: url(data:image/svg;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGg0OHY0OEgweiIvPjxwYXRoIGZpbGw9IiMyRjg4RkYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNOSA0MCA0IDE3bDEwIDVMMjQgOGwxMCAxNCAxMC01LTUgMjNIOVoiLz48cGF0aCBmaWxsPSIjNDNDQ0Y4IiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTI0IDMzYTQgNCAwIDEgMCAwLTggNCA0IDAgMCAwIDAgOFoiLz48L3N2Zz4=);
        }

        #wrapper.rotated {
            transform: rotate(90deg);
            transform-origin: top left;
            width: 100vh;
            height: 100vw;
            left: 100vw;
        }

        #overlay {
            background: rgba(0, 0, 0, 50%);
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
            position: absolute;
            z-index: 100;
        }

        #overlay > div {
            background-color: white;
            border-radius: 1em;
            padding: 1em;
            margin: 1em;
            box-shadow: 0 1em 1em rgba(0, 0, 0, 50%);
        }

        #scores {
            display: flex;
            flex-direction: row;
        }

        .score {
            flex-grow: 1;
            flex-basis: 0;
            text-align: center;
            font-size: 12vh;
        }

        #menuBtn {
            border: none;
            border-radius: 0;
            color: #444;
            background-color: #eee;;
            height: 100%;
            padding: 1em;
        }

        #menuBtn:hover, #menuBtn:active {
            background-color: #ddd;
        }

        #startMenu {
            display: flex;
            flex-direction: row
        }

        #blinker {
            position: fixed;
            top: 0;
            right: 0;
            font-size: 1rem;
            z-index: 200;
            pointer-events: none;
        }

        #cardField {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            flex-grow: 1;
            padding: min(1vw, 1vh);
            background-color: #eee;
        }

        .cardRow {
            flex-grow: 1;
            flex-basis: 0;
            display: flex;
            flex-wrap: nowrap;
        }

        .card {
            transition: 0.1s;
            padding: 0 1vw;
            flex-grow: 1;
            flex-basis: 0;
            background-color: #f8f8f8;
            border-radius: 5px;
            margin: max(0.5vw, 0.5vh);
            color: #333;
            box-shadow: 0 0.05em 0.1em rgb(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(4vw, 4vh);
            line-height: 1;
            text-transform: capitalize;
            user-select: none;
            text-align: center;
            word-wrap: anywhere;
            /*font-family: 'PT Sans Narrow', sans-serif;*/
        }

        .card.opened:not(.team-2) { opacity: 0.8}

        .team-2 { background-color: black;color: #cbcbcb}
        .team-1 {color: #443; background-color: #eaead4}
        .team0 { color: #733; background-color: lightpink }
        .team1 { color: #226; background-color: lightskyblue }
        .team2 { color: #131; background-color: lightgreen }
        .team3 { color: saddlebrown; background-color: yellow }

        .greyscale .word {background-color: rgba(255, 255, 255, 80%);}
        .greyscale .team-2 .word { background-color: #000; color: #fff }
        .greyscale .team-1 {background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIUlEQVQYV2NkIBIwEqmOgSKF/4G2YBhAkYlYnT0ETPwPABZzAgr9qxx+AAAAAElFTkSuQmCC);}
        .greyscale .team0 { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAMUlEQVQYV2NkwA/+M+KR/w+UY8SlACwJ0oxNAVwSmwIUSXQFGJLICrBKwhTglAQpAAAY5AgIyRpU6AAAAABJRU5ErkJggg==);}
        .greyscale .team1 {background: #aaa;}

        .captain .card {pointer-events: none}
        .captain .card.opened:not(.team-2) { opacity: 0.3;}
        .captain .card .word { user-select: none;}
        .captain .card.team-1 { background: white;}

        .card:hover {
            transition: 0.1s;
            box-shadow: 0 0.01em 0.4em #000;
            filter: brightness(110%);
        }

        .card.almost {
            transition: 1s cubic-bezier(0.0, 0.4, 0.5, 0.5);
            animation: ready 0.3s infinite 1s;
            transform: perspective(12cm) rotate3d(1, 0, 0, 40deg);
            box-shadow: 0 40px 20px rgba(0, 0, 0, 70%);
        }

        @keyframes ready {
            0% { transform: perspective(12cm) rotate3d(1, 0, 0, 40deg) }
            50% { transform: perspective(12cm) rotate3d(1, 0, 0, 35deg) }
            100% { transform: perspective(12cm) rotate3d(1, 0, 0, 40deg) }
        }

        .card.opening {
            transition: 0.5s;
            transform: perspective(12cm) rotate3d(1, 0, 0, 90deg);
        }

        .locale {
            float: right;
        }

        .locale > a {
            margin: 0 0.5em;
            font-size: smaller
        }

        label {
            margin-right: 0.5em;
        }
        .settings {
            margin-bottom: 1em;
        }

        .settings > div {
            display: flex;
            margin-bottom: 0.8em;
            flex-wrap: wrap;
        }
        .settings > div > * {
            margin-top: 0;
            margin-bottom: 0;
        }

        select {
            width: auto;
            height: auto;
            padding-top: 0;
            padding-bottom: 0;
        }


    </style>
</head>
<body>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/vue-i18n@9"></script>

<div id="app">
    <div :class="{greyscale: greyscale, captain: isCaptain, rotated: rotated}" id="wrapper">

        <div id="blinker">
            <span :style="{color: connectionStyle}">●</span><span
                :style="{color:  unansweredCount ? 'red' : ''}">●</span>
        </div>

        <div id="overlay" v-if="overlay">
            <div v-if="overlay === 'startMenu'">
                <div class="settings">
                    <div class="locale">
                        <a href="#" @click.prevent="$i18n.locale='ru'">РУС</a>
                        <a href="#" @click.prevent="$i18n.locale='en'">ENG</a>
                    </div>
                </div>
                <div>
                    <h3>{{$t('join')}}</h3>
                    <template v-if="showEnterForm || gameName">
                        <input type="text" v-model.trim="gameName"/>
                        <button type="button" @click="joinGame(true)" :enabled="!!gameName">{{$t('asCaptain')}}</button>
                        &nbsp;
                        <button type="button" @click="joinGame(false)" :enabled="!!gameName">{{$t('asGuesser')}}
                        </button>
                    </template>
                </div>
                <div class="settings">
                    <h3>{{$t('newGame')}}</h3>
                    <div>
                        <label for="fieldSize">{{$t('field')}} </label>
                        <select id="fieldSize" v-model.number="newGame.cardsCount" style="width: auto">
                            <option :value="30">6×5</option>
                            <option :value="25">5×5 - {{$t('standard')}}</option>
                            <option :value="20">5×4</option>
                        </select>
                    </div>
                    <div>
                        <label for="cardsSet">{{$t('set')}} </label>
                        <select id="cardsSet" v-model.number="newGame.cardsSet[$i18n.locale]">
                            <option v-for="w in availableWordLists" :value="w[0]">{{w[1]}}</option>
                        </select>
                    </div>
                    <div>
                        <label for="teamsCount">{{$t('teams')}} </label>
                        <select id="teamsCount" v-model.number="newGame.teamsCount">
                            <option :value="1">1 - {{$t('training')}}</option>
                            <option :value="2">2 - {{$t('standard')}}</option>
                            <option :value="3">3</option>
                            <option :value="4">4</option>
                        </select>
                    </div>
                    <div>
                        <label for="blackCards">{{$t('blacks')}} </label>
                        <select id="blackCards" v-model.number="newGame.blackCards">
                            <option :value="0">0</option>
                            <option :value="1">1 - {{$t('standard')}}</option>
                            <option :value="-1">{{newGame.teamsCount}}</option>
                        </select>
                    </div>
                    <button type="button" @click="initGame">{{$t('create')}}</button>
                </div>


            </div>
            <div v-if="overlay === 'gameMenu'">
                <h3>{{$t('gameCode')}}: <b>{{gameName}}</b></h3>
                <div class="settings">
                    <div><label for="fontScale">{{$t('fontScale')}}</label>
                        <input type="range" id="fontScale" min="50" max="150" step="5" v-model="fontScale"/>
                    </div>
                    <div><label for="rotation">{{$t('rotation')}}</label> <input id="rotation" type="checkbox"
                                                                                 v-model="rotated"/></div>
                    <div><label for="greyscale">{{$t('greyscale')}}</label> <input id="greyscale" type="checkbox"
                                                                                   v-model="greyscale"/></div>
                </div>
                <div>
                    <button type="button" @click="overlay=false">{{$t('close')}}</button>
                    &nbsp;
                    <button type="button" class="button-outline" @click="overlay='startMenu'">
                        {{$t('startMenu')}}
                    </button>
                </div>
            </div>
        </div>

        <template v-if="state">
            <div id="cardField">
                <div v-for="(row, rowIndex) in cardRows" :key="rowIndex" class="cardRow">
                    <div v-for="(card, cardIndex) in row" :key="cardIndex" class="card" :class="cardClass(card)"
                         ref="cards"
                         @mousedown="mDown(card)" @mouseup="mUp(card)" @mouseout="mOut(card)" @touchstart="mDown(card)"
                         @touchend="mUp(card)" @touchcancel="mOut(card)" @touchmove="tMove($event, cardIndex)">
                            <span class="word" :style="{fontSize: fontScale + '%'}"
                                  style="pointer-events: none">{{card.word}}</span>
                    </div>
                </div>
            </div>
            <div id="scores">
                <div class="score team0">{{state.score[0]}}</div>
                <button type="button" id="menuBtn" @click="menu">Меню<br/>…</button>
                <div v-for="(s,t) in state.score.slice(1)" class="score" :class="'team' + (t+1)">{{s}}</div>
                <div v-if="state.winner === -2" class="score team-2">!!!</div>
            </div>
        </template>
    </div>

</div>

<script>

    const openCardSound = new Audio("data:audio/mp3;base64,/+NIxAAAAAAAAAAAAFhpbmcAAAAPAAAABAAAAtAAKioqKioqKioqKioqKioqKioqKioqKioqgICAgICAgICAgICAgICAgICAgICAgICAgNXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dX/////////////////////////////////AAAAOUxBTUUzLjEwMAIeAAAAAAAAAAAUCCQDfiIAAAgAAALQ7fkhYwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAAK2AK+eUEQAABuAAAjIB/8H+XD/////4IAgCH/V+D4Pv8HwQcJwfBwEAx+XB8Hw/9AY8PqAEEkgAAFlkSaZP/8yAXq/+MoxA8h46LSWYKQAohnMZ05a///////0ay6ksxMjZf9fRRUigZUklGSRgRYgRMoCzhZoY1AknU7rMz5FyfBrn6MyRULOBEpBTVFEmTIni8tRNEyToPUmDQuGk0ZkGdCkmXVLRdFjE4RAaBPkVMnIaTRPE0Yl0u//0MmCc/0EK3dEsGwW7qAQDv/jYJ/jEF//+MoxAohc1qBQYGoAOlU3//+ir//12dJf///6RiYHCueICRxNnyKj6/+v/80IMNUZ0bIsoL9BkcBoAACBMGoiAzenQMAwUDToAosovJrPCziMBMFgZYVYGKykBjkJf9i8Q0mTQAUNjLADAUIAANkG4gTAoNg4DBAzAx0G/8N+HOTKSKRMuTLeF4Gf////////+MYxAcMoyWAEcAoA/////////zPUrU/qVQ6KsJB4WdQGAIDHAUAQKQBgFAEOkDwBCyh0PCxuisqTEFNRTMuMTAwqqqqqqqq");

    function isTouchEventWithElement(event, element) {
        const item = event.changedTouches.item(0);
        if (element === null || item === null) return false;
        const rect = element.getBoundingClientRect();
        return rect.right > item.clientX &&
            rect.left < item.clientX &&
            rect.top < item.clientY &&
            rect.bottom > item.clientY;
    }

    const messages = {
        ru: {
            asCaptain: "Капитан",
            asGuesser: "Игрок",
            field: "Поле",
            set: "Карточки",
            standard: "стандарт",
            teams: "Команды",
            training: "тренировка",
            blacks: "Чёрные карты",
            newGame: "Новая игра",
            create: "Создать",
            join: "Войти в игру",
            greyscale: "Режим оттенков серого",
            rotation: "Повернуть экран",
            fontScale: "Шрифт на карточках",
            close: "Закрыть",
            gameCode: "Код игры",
            startMenu: "В начальное меню"
        },
        en: {
            asCaptain: "Captain",
            asGuesser: "Player",
            field: "Table size",
            set: "Cards set",
            standard: "standard",
            teams: "Teams",
            training: "training",
            blacks: "Black cards",
            newGame: "New game",
            create: "Create",
            join: "Join game",
            greyscale: "Greyscale mode",
            rotation: "Rotate screen",
            fontScale: "Card font size",
            close: "Close",
            gameCode: "Game code",
            startMenu: "Main menu"
        }
    }

    const wordsLists = [
        [0, "Стандартные 400", "ru"],
        [1, "Default 400", "en"]
    ];

    const i18n = VueI18n.createI18n({
        locale: 'ru',
        fallbackLocale: 'en',
        messages,
    })

    const {createApp} = Vue
    const app = createApp({
        data() {
            return {
                net: {
                    websocket: null,
                    connectionState: WebSocket.CLOSED,
                    queueToSend: [],
                    sentCount: 0,
                    receivedCount: 0,
                    needConnection: false,
                },

                newGame: {
                    cardsCount: 25,
                    cardsSet: {'ru': 0, 'en': 1},
                    teamsCount: 2,
                    blackCards: 1
                },

                showEnterForm: false,
                overlay: 'startMenu',
                closeOnJoin: false,
                isCaptain: false,
                gameName: window.location.hash.replace('#', ''),


                fontScale: JSON.parse(localStorage.getItem('fontScale') || "100"),
                greyscale: JSON.parse(localStorage.getItem('greyscale') || "false"),
                rotated: JSON.parse(localStorage.getItem('rotated') || "false"),

                state: false,
            }
        },
        computed: {
            availableWordLists() {
                return wordsLists.filter(w => (w[2] === "" || w[2].indexOf(this.$i18n.locale) !== -1))
            },
            connectionStyle() {
                if (this.net.connectionState === WebSocket.OPEN) {
                    return "#0ea21a"
                } else if (this.net.connectionState === WebSocket.CONNECTING) {
                    return "#b07b19"
                } else if (this.net.needConnection) {
                    return "#c01616"
                } else {
                    return "#000"
                }
            },
            unansweredCount() {
                return this.net.sentCount - this.net.receivedCount
            },
            shouldSend() {
                return this.net.queueToSend.length + this.net.connectionState;
            },
            perRow() {
                return {20: 5, 25: 5, 30: 6}[this.state.cards.length]
            },
            cardRows() {
                const rows = [];
                let start = 0;
                while (start < this.state.cards.length) {
                    let end = start + this.perRow;
                    rows.push(this.state.cards.slice(start, end))
                    start = end
                }
                return rows
            }
        },
        methods: {
            mDown(card) {
                console.log("DOWN: " + card.word);
                if (!card.is_opened) {
                    card.almost = true;
                    card.mouseDownStart = new Date();
                }
            },
            mOut(card) {
                console.log("OUT: " + card.word);
                card.almost = false;
                card.mouseDownStart = false;
            },
            mUp(card) {
                console.log("UP: " + card.word)
                if (card.mouseDownStart) {
                    const deltaMs = new Date() - card.mouseDownStart;
                    if (deltaMs > 1000) {
                        this.openCard(card);
                    }
                }
                card.almost = false;
            },
            tMove(e, i) {
                if (!isTouchEventWithElement(e, this.$refs.cards[i])) {
                    this.mOut(this.state.cards[i])
                }
            },
            cardClass(c) {
                const cls = []
                if (c.is_opened) {
                    cls.push('opened')
                }
                if (c.is_opening) {
                    cls.push('opening')
                }
                if (c.just_opened) {
                    cls.push('just-opened')
                }

                if (c.is_opened || this.isCaptain) {
                    cls.push('team' + c.team)
                }

                if (c.almost) {
                    cls.push('almost')
                }
                return cls.join(" ")
            },
            initGame() {
                const perTeam = Number.parseInt(Math.floor(this.newGame.cardsCount / (this.newGame.teamsCount + 1)));
                const teamCardsCount = Array(this.newGame.teamsCount).fill(perTeam);
                teamCardsCount[0] = teamCardsCount[0] + 1;
                const rules = {
                    cards_set: this.newGame.cardsSet[this.$i18n.locale],
                    cards_count: this.newGame.cardsCount,
                    team_cards_count: teamCardsCount,
                    black_cards_count: this.newGame.blackCards === -1 ? (this.newGame.teamsCount - 1) : this.newGame.blackCards,
                };
                this.net.needConnection = true;
                this.net.queueToSend.push(JSON.stringify({action: 'init', rules: rules}));
            },
            joinGame(asCap) {
                this.isCaptain = asCap;
                this.net.needConnection = true;
                this.closeOverlayOnJoin = true;
                this.net.queueToSend.push(JSON.stringify({action: 'join', game: this.gameName}))
            },
            openCard(card) {
                if (card.is_opened) {
                    return
                }
                const i = this.state.cards.indexOf(card);
                card.is_opening = true;
                openCardSound.play()
                setTimeout(() => {
                    card.is_opening = false;
                    card.is_opened = true;
                }, 500)
                this.net.queueToSend.push(JSON.stringify({action: 'open', card: i, game: this.gameName}))
            },
            connectWs() {
                const wsPotocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
                this.net.websocket = new WebSocket(wsPotocol + "//localhost:8000/ws");
                this.net.connectionState = WebSocket.CONNECTING;
                this.net.websocket.onopen = () => {
                    this.net.connectionState = this.net.websocket.readyState;
                }
                this.net.websocket.onmessage = (event) => {
                    this.net.receivedCount++;
                    this.parseMessage(event.data)
                };
                this.net.websocket.onclose = (e) => {
                    console.info("Connection closed")
                    this.net.connectionState = this.net.websocket.readyState;
                }
            },
            parseMessage(s) {
                const data = JSON.parse(s)
                if (!data.success) {
                    console.error(data)
                }

                if (data.action === 'init') {
                    this.gameName = data.game
                    this.showEnterForm = true
                    window.location.hash = data.game
                } else if (data.action === 'state') {
                    this.state = data.state
                    this.gameName = data.game
                    window.location.hash = data.game
                    if (this.closeOverlayOnJoin) {
                        this.overlay = false
                    }
                }

            },
            menu() {
                this.overlay = "gameMenu"
            }
        },
        watch: {
            overlay(v) {
                if (v) {
                    this.closeOverlayOnJoin = false;
                }
            },
            shouldSend() {
                if (this.net.queueToSend.length === 0) {
                    return
                }
                if (this.net.connectionState === WebSocket.OPEN) {
                    this.net.websocket.send(this.net.queueToSend.shift());
                    this.net.sentCount++;
                } else if (this.net.connectionState === WebSocket.CLOSED && this.net.needConnection) {
                    this.connectWs();
                }
            },
            greyscale(v) {
                localStorage.setItem('greyscale', JSON.stringify(v))
            },
            rotated(v) {
                localStorage.setItem('rotated', JSON.stringify(v))
            },

            fontScale(v) {
                localStorage.setItem('fontScale', JSON.stringify(v))
            }
        },
    });
    app.use(i18n);
    app.mount('#app');
</script>

</body>
</html>